对称加密+非对称加密(HTTPS采用这种方式)
- 使用对称密钥的好处是解密的效率比较快
- 使用非对称密钥的好处是可以使得传输的内容不能被破解，因为就算你拦截到了数据，但是没有对应的私钥，也是不能破解内容的。
  
就比如说你抢到了一个保险柜，但是没有保险柜的钥匙也不能打开保险柜。
那我们就将对称加密与非对称加密结合起来,充分利用两者各自的优势，
> 在交换密钥环节使用非对称加密方式，之后的建立通信交换报文阶段则使用对称加密方式。

具体做法是：发送密文的一方使用对方的公钥进行加密处理`对称的密钥`，
然后对方用自己的私钥解密拿到`对称的密钥`，
这样可以确保交换的密钥是安全的前提下，使用对称加密方式进行通信。
所以，HTTPS采用对称加密和非对称加密两者并用的混合加密机制。


![](https_work_flow.png)
1. Client发起一个HTTPS（https:/demo.linianhui.dev）的请求，根据RFC2818的规定，Client知道需要连接Server的443（默认）端口。
2. Server把事先配置好的公钥证书（public key certificate）返回给客户端。
3. Client验证公钥证书：比如是否在有效期内，证书的用途是不是匹配Client请求的站点，
   是不是在CRL吊销列表里面，它的上一级证书是否有效，这是一个递归的过程，
   直到验证到根证书（操作系统内置的Root证书或者Client内置的Root证书）。
   如果验证通过则继续，不通过则显示警告信息。
4. Client使用伪随机数生成器生成加密所使用的会话密钥，然后用证书的公钥加密这个会话密钥，发给Server。
5. Server使用自己的私钥（private key）解密这个消息，得到会话密钥。至此，Client和Server双方都持有了相同的会话密钥。
6. Server使用会话密钥加密“明文内容A”，发送给Client。
7. Client使用会话密钥解密响应的密文，得到“明文内容A”。
8. Client再次发起HTTPS的请求，使用会话密钥加密请求的“明文内容B”，然后Server使用会话密钥解密密文，得到“明文内容B”。

简单总结下，HTTPS是使用了证书的一个混合密码系统，其中证书的作用在于传递会话密钥，以及验证网站的真实性；
而HTTPS真正的加密操作是由对称密码这个工具负责的（有兴趣的可以找找每个步骤中都用到了密码工具箱中的那些工具）。
在windows系统中，可以配置一个名为 SSLKEYLOGFILE 的环境变量，Chrome和Firefox在访问HTTPS站点的时候，
会把第4步生成的会话密钥以及其他附属信息，写入到这个文件中：

## https跳过证书原理
假设我访问自签证书的网站，使用curl -k(跳过证书合法性校验)， 不校验证书正确性，
由于os/浏览器根本就没有这个自签证书的public key, 那肯定解密不出证书的数据， 
例如server的公钥,那不是和正常流程又有区别了，但是还是能访问的页面内容，这个就很奇怪。
那么后面的通信又是怎么进行的呢? 是否还走加密通信方式? 以及server公钥从证书里拿不出来的问题。

对于上面的疑惑: 跳过https校验是否还走加密通信的方式? 底层实现，证书解不开，server端公钥拿不到又怎么解释?

1. 肯定还是走TLS加密通信。
   
   因为人家网站就是基于https的，肯定是加密的，这个不用质疑，不会存在说你跳过证书校验就不走加密了。
2. TLS可以分为2个功能方面来理解：
   1.  是 ca证书身份认证
   2. 是后面数据进行加密通信，保证在传输过程中不被篡改。 
      
    **两个方面没有必然前置关系，也就是ca证书校验是可以在客户端进行选择校验还是不校验**，和下面第2步加密通信无关。
   校验就走校验规则，不校验也可以走第2个步骤继续加密通信。 
   
   >只是说， 这时候由于证书解密解不出来，server的公钥拿不出来了，
   那系统就不能走RSA非对称加密算法来传递"会话密钥"， 
   TLS客户端会自动转化使用DH算法(个人理解:类似生成临时非对称加密秘钥对,是传递"会话密钥")，完成后面加密通信的过程。
   
使用自签TLS证书通信虽然是加密的，但是https身份认证的功能也就荡然无存了。
任何人都可以自签发证书，容易受到中间人攻击以及伪装。 
中间人也自己签发证书，替换掉你的证书，客户端也察觉不到的。谁叫你自己不校验呢? 
就像电话诈骗， 警察再三提醒你对法对方可能是骗子(不安全提示)，
你还是傻不拉几地坚持汇款，那肯定是能汇款的啊，银行又不能阻止你汇款，但是后果自己承担。

## https性能
1. TCP 协议需要通过三次握手建立 TCP 连接保证通信的可靠性（1.5-RTT）；
2. TLS 协议会在 TCP 协议之上通过四次握手建立 TLS 连接保证通信的安全性（2-RTT）；
3. HTTP 协议会在 TCP 和 TLS 上通过一次往返发送请求并接收响应（1-RTT）
