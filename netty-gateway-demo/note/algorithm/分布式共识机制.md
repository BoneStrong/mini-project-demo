## 拜占庭将军问题
拜占庭将军问题是一个协议问题。拜占庭帝国军队的将军们必须全体一致的决定是否攻击某一支敌军。
问题是这些将军在地理上是分隔开来的，并且将军中存在叛徒。
叛徒可以任意行动以达到以下目标：
- 欺骗某些将军采取进攻行动；
- 促成一个不是所有将军都同意的决定，如当将军们不希望进攻时促成进攻行动；
- 或者迷惑某些将军，使他们无法做出决定。
  
如果叛徒达到了这些目的之一，则任何攻击行动的结果都是注定要失败的。
只有完全达成一致的努力才能获得胜利。

拜占庭假设是对现实世界的模型化，由于硬件错误、网络拥塞或断开以及遭到恶意攻击，计算机和网络可能出现不可预料的行为。

### 拜占庭将军问题分析
究其根底，`拜占庭将军问题`最终想解决的是互联网交易、合作过程中的四个问题：
1. 信息发送的身份追溯
2. 信息的私密性
3. 不可伪造的签名
4. 发送信息的规则

仅拿比特币世界来说，我们可以将每一个比特币交易账号看作一个将军，
这些账号分布在世界各地，无法聚在一起，很可能会有恶意账号，
账号之间的沟通也很可能因为机器坏了、网络断了、黑客攻击等受到破坏，
并且有关账号是不是要支付、具体支付多少的讨论也会浪费很多时间.

# 共识机制
目前有4种方式：工作量证明(proof of work)，权益证明(proof of stake)，委托权益证明，授权拜占庭容错算法

**拜占庭问题之所难解的很重要的一个原因就是因为各个节点提出提案的成本很低，
所以在任何时候系统内可能存在多个提案，这就造成了在整个分布式系统想要完提案的最终确认变得十分困难，容易收到干扰**。

比特币公链进行设计的时候提出了POW的算法思路，POW算法来解决拜占庭问题的思路有两条：

- 限制一段时间内网络中出现提案的数量。也就是说每个节点在提出提案之前需要运行哈希现金（HashCash）的算法，
  即需要在一个交易块中找到一个随机数，计算机只能通过穷举法来找到这个随机数。
  同时中本聪设计了时间戳的机制，为每个节点的出块时间加上印章来保证公平性。

- 弱化对于一致性确认的需求。在比特币网络中各个节点都确定验证已知的最长链进行延伸。
  由于POW机制弱化了网络对于一致性（Consistency）的需求，所以同一时刻访问比特币的不同节点，
  得到的内容并不一致，甚至网络会出现分叉的情况。但是整个网络的可用性（Availability）和分区容忍性（Partition）都得到了提升。

同时比特币采用非对称加密的密码学技术来保证信息内容的安全，同时让信息的接收者使用公钥来验证信息发送者的身份，
这就让网络中的所有身份都可以得到验证。这就让一个分布式的不可信的网络变成了一个可信的网络。
这样即便网络中出现蓄意发起攻击者也要发送50%以上的算力，自己的利益也收到损失。
后续的其他各种POX（Proof Of X）基本上也是沿袭这个思路进行优化和改进，采用经济上的惩罚来制约破坏者。

## 1.工作量证明 (POW)
区块链轻而易举地解决了这`拜占庭将军问题`。
它为信息发送加入了成本，降低了信息传递的速率，而且加入了一个随机元素使得在一定时间内只有一个将军可以广播信息。
这里所说的成本就是区块链系统中基于随机哈希算法的`工作量证明`。
哈希算法所做的事情就是计算获得的输入，得到一串64位的随机数字和字母的字符串。

区块链系统计算的输入数据是指节点发送的当前时间点的整个总账。
当前计算机的算力使其可以实时计算出单个哈希值，但是区块链系统只接受前13个字符是0的哈希值结果作为`工作量证明`。
而前13个字符是0的哈希值是非常罕见的，需要整个网络花费10分钟的时间才在数以亿计的数据中找到一个。
在一个有效的哈希值被计算出来之前，网络中已经生产了无数个无效值，这就是降低信息传递速率并使得整个系统成功运行的`工作量证明`。

在拜占庭将军问题中，第一个广播信息的将军就是第一个发现有效哈希值的计算机，
只要其他将军接收到并验证通过了这个有效哈希值和附着在上面的信息，他们就只能使用新的信息更新他们的总账复制，然后重新计算哈希值。
下一个计算出有效哈希值的将军就可以将自己再次更新的信息附着在有效哈希值上广播给大家。
然后哈希计算竞赛从一个新的开始点重新开始。由于网络信息的持续同步，所有网络上的计算机都使用着同一版本的总账。

比特币区块链系统找到有效哈希值的时间间隔为10分钟，这是算法设置好的。
算法难度每隔两周调整一次就是为了保证这10分钟的间隔，不能多也不能少。
每隔10分钟，总账的信息就会在区块链更新并在全网同步一次。
因此分散的交易记录是在所有网络上的计算机之间进行对账和同步的。

当个人用户在区块链系统发起一笔交易的时候，他们会使用私钥和公钥为这笔交易签名.
而内嵌在比特币系统的标准公钥则承担了加密工具的角色，对应在拜占庭将军问题中，加密工具就是用于签名和验证消息的印章。

因此，哈希算法对信息传递速率的限制加上加密工具使得区块链构成了一个无须信任的数据交互系统。
在区块链上，一系列的交易、时间约定、域名记录、政治投票系统或者任何其他需要建立分布式协议的地方，参与者都可以达成一致。


难度值（difficulty）是矿工们在挖矿时候的重要参考指标，它决定了矿工大约需要经过多少次哈希运算才能产生一个合法的区块。
比特币的区块大约每10分钟生成一个，如果要在不同的全网算力条件下，新区块的产生保持都基本这个速率，
难度值必须根据全网算力的变化进行调整。简单地说，难度值被设定在无论挖矿能力如何，新区块产生速率都保持在10分钟一个。

难度的调整是在每个完整节点中独立自动发生的。每2016个区块，所有节点都会按统一的公式自动调整难度，
这个公式是由最新2016个区块的花费时长与期望时长（期望时长为20160分钟即两周，是按每10分钟一个区块的产生速率计算出的总时长）比较得出的，
根据实际时长与期望时长的比值，进行相应调整（或变难或变易）。
也就是说，如果区块产生的速率比10分钟快则增加难度，比10分钟慢则降低难度。

这个公式可以总结为如下形式：
> 新难度值 = 旧难度值 * ( 过去2016个区块花费时长 / 20160 分钟 )

工作量证明需要有一个目标值。比特币工作量证明的目标值（Target）的计算公式如下：
>目标值 = 最大目标值 / 难度值

其中最大目标值为一个恒定值：
> 0x00000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF

目标值的大小与难度值成反比。比特币工作量证明的达成就是矿工计算出来的区块哈希值必须小于目标值。
我们也可以简单理解成，比特币工作量证明的过程，就是通过不停的变换区块头（即尝试不同的nouce值）作为输入进行SHA256哈希运算，
找出一个特定格式哈希值的过程（即要求有一定数量的前导0）。而要求的前导0的个数越多，代表难度越大。

我们可以把比特币矿工解这道工作量证明迷题的步骤大致归纳如下：
> 生成Coinbase交易，并与其他所有准备打包进区块的交易组成交易列表，通过Merkle Tree算法生成Merkle Root Hash
把Merkle Root Hash及其他相关字段组装成区块头，将区块头的80字节数据（Block Header）作为工作量证明的输入
不停的变更区块头中的随机数即nonce的数值，并对每次变更后的的区块头做双重SHA256运算（即SHA256(SHA256(Block_Header))）
，将结果值与当前网络的目标值做对比，如果小于目标值，则解题成功，工作量证明完成

为什么比特币固定10分钟出一个块
比特币的做法是，交易账本数据按照时间分块存储，每一块只存储10分钟的交易账本数据，
这每个存储单元即称之为“区块”。而每一个区块的头部会记录这一数据块的序号、时间和Hash摘要数据。
比较巧妙的地方在于，区块头部中的Hash摘要数据是由上一个区块的摘要数据和本区块的交易账本数据叠加后经过Hash函数得到的，即：
>第n块的Hash值 = Hash(第n-1块的Hash值 + 第n块的账本数据)

可以看到，虽然每一个区块内的交易账本数据是独立的，但是区块头部的Hash值却是依赖于上一区块的Hash值，
从而形成了一条链式的结构。这想必也就是“区块链”名字的由来。
链上的任何一个区块中的数据受到的篡改，都将反映到最新的一个区块的Hash值上，
因此，要想验证某个节点的账本数据是否正确，只需要比对最新一个区块的Hash值即可。

## 2.权益证明 (POS)
与要求证明人执行一定量的计算工作不同，权益证明要求证明人提供一定数量加密货币的所有权即可。
权益证明机制的运作方式是：
当创造一个新区块时，矿工需要创建一个`币权`交易，交易会按照预先设定的比例把一些币发送给矿工本身。
权益证明机制根据每个节点拥有代币的比例和时间，依据算法等比例地降低节点的挖矿难度，从而加快了寻找随机数的速度。

**这种共识机制可以缩短达成共识所需的时间，但本质上仍然需要网络中的节点进行挖矿运算**。
因此，PoS机制并没有从根本上解决PoW机制难以应用于商业领域的问题。

### 2.1 权益证明流程
#### 2.1.1 币龄
币龄这个概念其实很好理解，它的英文是 CoinAge，字面意思就是币数量乘以天数。

比如你有100个币，在某个地址上9天没有动，那么产生的币龄就是900，
如果你把这个地址上这100币转移到任意地址，包括你自己的地址，
那么900个币龄就在转移过程中被花费了，你的币数量虽然还是100个，但是币龄变更为0。
币龄在数据链上就可以取到，任何人都可以验证。

我们回过头来看看PoS究竟是什么，**区块链共识机制的第一步就是随机筛选一个记账者**，
PoW是通过计算能力来获得记账权，计算能力越强，获得记账权的概率越大。
**PoS则将此处的计算能力更换为财产证明，就是节点所拥有的币龄越多，获得的记账的概率就越大**。
这有点像公司的股权结构，股权占比大的合伙人话语权越重。

#### 2.1.2 权益证明实现原理
我们知道PoW挖矿的基本逻辑和步骤，即找到一个nonce值，使得新区块头的哈希值小于某个指定的值，即区块头结构中的`难度目标`
```bash
Hash (block_header) < Target
```
从公式中我们可以看到，PoW下所有矿工的目标值是一样的，只要计算结果哈希小于目标值即可，简化来看就是前导0的个数。
而在PoS系统中，这个公式变更为：
```bash
Hash (block_header) < Target * CoinAge
```
我们可以看出多引入了一个变量叫做CoinAge，也就是币龄，这里就有意思了。

**这个变量为会造成每个矿工看到的目标值不一样，如果你的币龄越大，也就意味着你的获得答案越容易**。
这里的Target与PoW一致，与全网难度成反比，用来控制出块速度的。

例如当前全网的目标是4369，A矿工的输入的币龄是15，那么A矿工的目标值为65535，
换算成十六进制就是0xFFFF，完整的哈希长度假设是8位，也就是0x0000FFFF。

而B矿工比较有钱，他输入的币龄是240，那么B矿工的目标值就是0x000FFFFF。
你如果仔细观察肯定会发现，相比A矿工的目标值，B直接少了一个零。即如下：
- A 矿工 Hash( block_header ) < 0x0000FFFF
- B 矿工 Hash( block_header ) < 0x000FFFFF
所以B矿工获得记账权的概率肯定要比A高。

#### 2.1.3  PoS的相关问题
通过上述的介绍我们知道：**PoS似乎完美地解决了PoW挖矿资源浪费的问题，甚至还顺带解决了51%攻击的问题**。
这里可以顺便讲一下51%攻击是什么，它是指PoW矿工如果积累了超过51%的算力，则可以一定程度篡改账本。

这里顺便科普一下，什么是51%攻击呢，我们发现，矿工挖矿的成本不再是物理设备和电费，
而是虚拟代币，它的边际成本几乎为零，本质上PoS让挖矿者和使用者合二为一了。

这也意味着如果挖矿者发起51%攻击，就需要拥有全网51%的币或币龄，这几乎不可能办到，即使你成功地实施了51%攻击，
那么也意味着作为全网最大的持币大户的你，损失也会最大。

PoS看起来相当完美，其实并不然，PoS有很多缺陷。
1. 币发行的问题
   
    一开始的时候，只有创始区块上有币，意味着只有这一个节点可以挖矿，所以让币分散出去才能让整个网络壮大，那么如何分散出去又是另外一个难题了。

    所以早期PoS币种基本都采用了分阶段挖矿，有的叫混合挖矿。
    很多币种其实是分了阶段的，即第一阶段是PoW挖矿，到第二阶段才是PoS挖矿。
    随着ERC20类型的标准合约代币的出现，这个问题被解决了，不再需要第一阶段改成PoW，也可以将代币分散出去。

2. 币囤积问题
   
    第二个问题是由于币龄是与时间挂钩的，这也意味着用户可以无限囤积一定的币，等过了很久再一次性挖矿发起攻击；
    所以解决方案是：PoS机制需要引入一个时间上限来控制时间因素的自然增长。

    虽然引入了时间上下限，用户还是倾向于囤积代币，这会造成币流通的不充分；
    基于此，所以瑞迪币引入了币龄按时间衰减，构造了权益速度证明，鼓励用户流动代币，而不是倾向于囤积代币。

3. 离线攻击问题
   
    即使引入了时间上下限，时间仍然是自然流动的，也就是可以不需要求挖矿节点长时间在线。
   挖矿是可以离线的，这简直是灾难，所以任意一个PoS机制的实践形式都必须避免这个问题，因为网络节点数量的多少直接关系到区块链网络的健壮性。

当然这些问题都不是致命问题，还记得我们一开始提到了PoS经历了三个版本，而第二个版本PoS 2.0使用的不是币龄，而直接是币的数量。

这会造成完全不同的结果，上述第二、三问题都不存在了，似乎看起来直接使用币的数量会更好一些，但却出现了整个PoS机制的致命问题。

这个问题叫做Nothing at Stake，翻译过来叫做无成本利益问题。
大体的意思在PoS系统中做任何事几乎没有成本，比如在PoS系统上挖矿几乎没有成本，这也就意味着分叉非常方便。
方便到什么程度呢，每个诚实矿工在产生孤块的时候都可以继续挖下去，反正也没什么成本，
反正分叉链和主链都可以同时挖，也就是任何持币较少的用户都可以尝试分叉，并且把分叉链广播出去。

这个时候如果其他诚实矿工看到了，第一反应也是没有成本，那么咱们也来挖吧，说不定什么时候就值钱了，
意思就是说任何逐利的矿工并不会使这个系统变得更强壮稳定，而是更加的混乱。

**无成本利益问题无论以币龄还是币数量作为PoS的参数，都无法避免**。

而PoW则没有这样的问题，我们回到PoW系统中来看，因为任何的分叉都会造成挖矿成本直接变成负收益，
所以这会抵抗分叉的产生，矿工倾向于跟随`最长`的链。

##### POS Casper协议
由于以太坊部分采用了PoS共识，它的名字叫做Casper，它必须解决上述无成本利益问题攻击。
所以Casper协议要求PoS矿工需通过抵押保证金的方法对共识结果进行下注，具体实践流程如下。
1. 首先，验证者将质押部分以太币作为权益证明。
2. 之后，他们将开始验证区块。即：当他们发现自己认为可以添加到链中的区块时，将通过在其上下注来对其进行验证。
3. 如果添加了区块，则验证者将获得与其下注成比例的奖励。
4. 但是，如果验证者以恶意的方式行事并且试图做“无利害关系”，他们将立即受到谴责，其质押的所有以太币将被削减。

正因为Casper协议被设计为在不信任的系统中工作，并且具有更高的拜占庭容错能力。
任何以恶意/拜占庭方式行事的人都会立即受到惩罚，被砍掉部分权益。
这与大多数其他POS协议不同。恶意因素会有所损失，因此它不可能有任何危险。

### 3. 委托权益证明（DPOS）
DPoS 股份授权证明机制引入了`受托人`的角色。

#### 3.1 DPoS 的运作机制如下：
1. 所有持币者先选出受托人负责签署区块：选举过程比较类似由股东会选举出董事会（101人代表），
代替股东会做出日常营运决策。授权董事会后，决策会更有效率 
（相较于PoW每10分钟产生一个区块，DPoS每3秒钟即可产生一个区块。）

2. 与PoW相同，DPoS的规则也是最长链胜出。
   其中每个受托人必须按照生产排程，轮流产生区块，拿一间工厂作为比方，
   假设排程排定A、Ｂ、Ｃ分别轮早、中、晚班生产，
   Ａ在晚上是无法刷门禁卡进入厂房生产的，同样地，C在早班时段也是无法进厂房的。

3. 今天有一些恶意的节点生产了分叉区块，假设Ａ、Ｃ都是诚实的节点，只有B节点是恶意的，
   由于B产生区块的速度（每9秒只能产生1个）慢于A、Ｃ合力产生区块的速度（每9秒产生2个），
   根据最长链胜出的规则，诚实的节点还是会胜出。
   
4. 同理，因为一个节点要产生重复两个区块的速度必定慢于诚实区块产生的速度，
   所以根据最长链胜出的规则，诚实的节点还是会胜出。
   
5. 如果今天A、Ｂ、Ｃ三个受托人的网络有段时间是碎片化、各自为政的呢？
   在短期内的确有可能三链并行，但一旦网络连结恢复，短链自然会向最长的链回归。
   因为受托可签署人数为奇数，所以两大派系势均力敌僵持不下的情况不会维持太久，最终势必会有其中一方的链更长。

#### 3.2 DPoS 对恶意节点的处罚
注册成为候选受托人需要支付一笔保证金（约10 XTS)，就像是参与民意代表选举前缴纳的保证金一样，
一般来说担任受托人约两周后才可达到损益平衡，这促进了受托人的稳定性，确保至少会挖满两周的矿。

惩罚机制为：**不按排程产生区块的节点将在下一轮被投票剔除，也会被没收之前缴纳的保证金**。

DPoS优缺点：
- 优点是效率较PoW和PoS更高、产生区块的速度更快；
- 缺点是虽然恶意的节点将在下一轮投票被踢出，但单个恶意区块在短期仍有可能是有效的状态。

短期虽然可能存在恶意区块，但长期下来，可以透过受托人的自主选择来回归链条的有效性：
假定现在总共有3个受托人A、Ｂ、Ｃ，D加入排程后，只要确认之前的区块中，有2/3以上个受托人遵循的链是哪条就可以了。

使用委托权益证明协议的典型代表：EOS区块链

### 4. 授权拜占庭容错算法（DBFT）
现在我们来谈谈NEO的共识机制选择。

想象有一个国家`Blockgeeks`，这个国家有很多公民。这些公民中的每一个都会选出一个代表来代表他们并使他们高兴。
这些代表的职责是通过法律，使公民感到高兴，如果他们不擅长自己的工作，则公民可以在下一次简单地投票给另一位代表。

那么，代表们如何通过法律？

一位代表被随机选为议长。议长研究公民的所有要求并制定法律。
然后，他们计算这些法律的“幸福因子”，以查看该数字是否足以满足公民的需求。
他们将其传递给代表们。然后，代表们分别检查议长的计算。
如果议长的数字与代表们的数字相符，则表示同意；否则，则表示不赞成。
66%的代表需要批准才能通过法律。如果没有被大多数人认可，则选择新的领导者，然后该过程再次开始。

让我们看下这种共识决策模式在区块链中的应用。

公民是拥有NEO令牌（又称普通节点）的人。代表是簿记节点。
**为了成为簿记节点，需要满足一定的条件：拥有专用设备、专用的互联网连接和一定数量的GAS**（根据basiccrypto的文章，为1000）。

- `公民的需求`基本上是代币持有人进行的各种交易。
- `法律`是要添加到区区块链的当前区块。
- `幸福因子`是当前区块的哈希值。

现在，在两种情况下，其中一个参与者可能以恶意方式行事。1个议长，3个代表。让我们来看看:
1. 议长是恶意的
   
   在这种情况下，议长已向两个代表发送了恶意消息B，并向一个代表发送了准确消息。
   由于多数规则，可以轻松缓解这种情况。
   两位代表将看到他们的哈希值与议长的哈希值不匹配，而一位代表将看到他们的哈希值完美匹配。
   但是，三分之二的人会拒绝该提案，并且无法达成共识。此后议长将被废除，重选议长。

2. 一名代表是恶意的

   议长向所有代表发送了正确的消息，但是其中一位代表决定以恶意的方式行事，并声明他的数字与议长的数字不符。
    但是，由于3位代表中有2位是非恶意的，因此他们将批准该法律，因为已达成66%的共识，该法律将获得通过。

可以看出，dBFT提供了一种非常有趣的共识机制形式。

使用授权拜占庭容错算法的典型代表：NEO区块链

**为什么PBFT算法最大容错节点数量f是(N-1)/3**？
>假定节点总数是N，作恶节点数为f，那么剩下的正确节点数为N - f，
> 意味着只要收到N - f个消息且N - f > f就能做出决定，
> 但是这N - f个消息有可能有f个是由作恶节点冒充的（或因网络延迟导致f个恶意节点的消息先被收到），
> 那么正确的消息就是N - f - f个，为了多数一致，正确消息必须占多数，也就是N - f - f > f ，
> 所以N最少是3f + 1个。

PBFT算法流程

## 总结
以上这些是在公链中使用最常见的4种共识机制。但是，还有更多的共识机制以提供选择。他们是：
- 能力证明机制 (proof of capacity)
- 消逝时间证明 (proof of elapsed time)
- 融入知识证明的工作量证明 (entangled proof of work and knowledge, EWoK)
- 融入知识证明的工作量证明 (entangled proof of work and knowledge, EWoK)

虽然工作量证明和权益证明无疑是最受欢迎的选择，但是时不时会有更新的共识机制出现。
没有`完美`的共识机制，而且有可能永远不会出现，但未来的新公链往往是伴随新的共识协议而诞生的。

## 共识机制发展趋势
区块链共识机制是区块链技术的核心, 未来的发展趋势主要有以下几点:
- **安全层面**：
  设计并完善可证明安全的区块链共识机制，解决如POS机制面临的安全威胁;
  将经典分布式一致性算法与区块链技术结合, 利用委员会实现强一致性, 解决委员会重配置的安全问题;

- **扩容层面**：
  利用分片技术, 通过计算分片、通信分片和存储分片, 实现交易处理的可扩展性, 解决跨片交易问题;
  利用 DAG 技术, 采用并行区块的架构, 使得同一时间内区块链能够容纳更多的交易;

- **启动层面**：
  通过安全多方计算等密码技术在非可信环境下完成协议自启动, 解决区块链协议的初始化问题; 
  通过对区块链历史数据的合理裁剪, 使新加入节点能够快速获取当前区块链状态, 参与共识运行, 解决新加入节点的启动问题;

- **激励层面**：
  设计合理可行的奖励和惩罚机制, 以理性用户作为出发点, 激励用户以诚实行为参与共识机制的运行和维护; 
  合理惩罚恶意用户, 同时给予举报者一定的奖励。